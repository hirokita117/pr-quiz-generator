# セキュリティ監査レポート

## 1. はじめに

このレポートは、`pr-quiz-generator` アプリケーションのソースコードを対象としたセキュリティ監査の結果をまとめたものです。監査の主な目的は、アプリケーションの設計と実装に存在する潜在的なセキュリティ脆弱性を特定し、そのリスクを評価し、具体的な改善策を提案することです。

## 2. 監査概要

- **監査対象**: `pr-quiz-generator` のソースコードリポジトリ
- **監査日**: 2025-08-09
- **重大度**: <span style="color:red; font-weight:bold;">緊急</span>

## 3. 発見された脆弱性

### 3.1. 【重大】APIキーのクライアントサイドへの漏洩

#### 脆弱性の内容

アプリケーションは、Viteの環境変数の仕組みを利用して、APIキーをフロントエンドのコードに直接埋め込んでいます。具体的には、以下の環境変数が `.env` ファイルに設定され、`VITE_` プレフィックスが付与されています。

- `VITE_GITHUB_TOKEN`
- `VITE_OPENAI_API_KEY`
- `VITE_GOOGLE_API_KEY`

Viteの仕様上、`VITE_` プレフィックスを持つ環境変数は、ビルド時にJavaScriptバンドル内に文字列として展開されます。その結果、**これらの機密情報であるAPIキーが、ブラウザでアプリケーションにアクセスしたすべてのユーザーから閲覧可能な状態になっています。**

`src/utils/env.ts` ファイルでは、`import.meta.env` を通じてこれらのキーが読み込まれ、`src/services/ai.ts` や `src/services/github.ts` でAPIリクエストを行う際に直接使用されています。

#### 再現手順

1. ブラウザでアプリケーションを開きます。
2. ブラウザの開発者ツール（F12キーなど）を開きます。
3. 「ソース」または「Sources」タブを選択し、アプリケーションのJavaScriptソースコード（例: `assets/index-*.js`）を検索します。
4. ソースコード内で `sk-` (OpenAI)、`AIza` (Google)、`ghp_` (GitHub) などのAPIキーの典型的なプレフィックスを検索すると、ハードコードされたキーが見つかります。

### 3.2. 【参考】依存関係

`npm audit` を実行した結果、監査時点での依存関係に既知の脆弱性は発見されませんでした。これは良好な状態ですが、継続的な監視が推奨されます。

## 4. リスク評価

この脆弱性は、以下の深刻なリスクをもたらします。

- **APIキーの不正利用**: 攻撃者は漏洩したAPIキーを悪用し、開発者のアカウントでGitHub、OpenAI、GoogleのAPIを無制限に呼び出すことができます。
- **金銭的被害**: OpenAIやGoogle AIのAPIは従量課金制です。攻撃者による大量のAPIコールは、予期せぬ高額な請求につながる可能性があります。
- **GitHubアカウントへの不正アクセス**: 漏洩したGitHubトークンに与えられた権限によっては、リポジトリのコードを読み取られたり、悪意のあるコードを書き込まれたりする可能性があります。
- **サービス停止**: APIキーが不正利用された結果、サービスプロバイダーによってキーが無効化され、アプリケーションが機能しなくなる可能性があります。
- **信頼性の失墜**: 機密情報の管理が不適切であるとみなされ、ユーザーや組織からの信頼を失う原因となります。

## 5. 推奨される改善策

この脆弱性を根本的に解決するためには、**APIキーをクライアントサイドから完全に分離する**必要があります。具体的な解決策として、**Backend-for-Frontend (BFF)** パターンの導入を強く推奨します。

### 5.1. BFFアーキテクチャの導入

現在のアーキテクチャでは、フロントエンドが直接外部API（GitHub, OpenAIなど）と通信しています。

**現状のアーキテクチャ:**
```
[ブラウザ (React App)] ---- (APIキーを含むリクエスト) ---> [外部API (GitHub, OpenAI)]
```

これを、フロントエンドと外部APIの間に専用のバックエンド（BFF）を配置する構成に変更します。

**推奨アーキテクチャ:**
```
[ブラウザ (React App)] ---- (リクエスト) ---> [BFF (Node.js/Express, Vercel/Netlify Functionsなど)] ---- (APIキーを付与してリクエスト) ---> [外部API (GitHub, OpenAI)]
```

### 5.2. 実装手順

1. **BFFサーバーの構築**:
   - Node.jsとExpressのような軽量なフレームワーク、またはVercelやNetlifyが提供するサーバーレス関数を利用して、APIリクエストを中継するためのエンドポイントを作成します。
   - 例えば、`/api/pr-quiz` のようなエンドポイントをBFFに作成します。

2. **環境変数の再設定**:
   - BFFサーバーの環境変数として、`GITHUB_TOKEN`、`OPENAI_API_KEY` のように、`VITE_` プレフィックスを**付けずに**APIキーを設定します。これにより、キーはサーバーサイドにのみ留まり、フロントエンドには公開されません。
   - フロントエンドの `.env` ファイルからは、これらの機密性の高いキーをすべて削除します。

3. **フロントエンドの修正**:
   - `src/services` 内のコードを修正し、GitHubやOpenAIのAPIエンドポイントを直接呼び出す代わりに、BFFの対応するエンドポイント（例: `/api/pr-quiz`）を呼び出すように変更します。

4. **BFFのロジック実装**:
   - BFFはフロントエンドからリクエストを受け取ると、サーバーサイドで環境変数からAPIキーを読み込みます。
   - 読み込んだAPIキーをリクエストヘッダーに付与し、本来の外部API（GitHub, OpenAIなど）にリクエストを転送します。
   - 外部APIからのレスポンスを受け取り、必要に応じて加工してからフロントエンドに返却します。

この構成により、機密情報であるAPIキーが安全なサーバー環境内に留まり、クライアントサイドに漏洩するリスクを完全に排除できます。

## 6. まとめ

本監査により、APIキーがクライアントサイドに漏洩するという重大なセキュリティ脆弱性が特定されました。この問題は、金銭的損失やアカウントの不正利用など、深刻な被害を引き起こす可能性があります。

提示された改善策（BFFアーキテクチャの導入）を速やかに実施し、アプリケーションのセキュリティを確保することを強く推奨します。
